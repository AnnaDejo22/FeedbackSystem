@inject HttpClient Http
@using FeedbackSystem.Contracts.DTO
@using System.Collections.Generic

<div class="feedback-list">

    @if (filteredFeedbacks == null)
    {
        <p>Loading feedback...</p>
    }
    else if (!filteredFeedbacks.Any())
    {
        <p>No feedback available.</p>
    }
    else
    {
        <div class="main-container">

            <div class="mb-3">
                <button class="btn btn-secondary me-2" @onclick="()=>LoadFeedbacks(null)">All Feedbacks
                </button>

                <button class="btn btn-primary me-2" @onclick="()=>LoadFeedbacks(0)">New Feedbacks
                </button>

                <button class="btn btn-success" @onclick="()=>LoadFeedbacks(1)">Reviewed Feedbacks
                </button>
            </div>

            <div>
                <form class="d-flex" role="search">
                    <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search"/>
                    <button class="btn btn-outline-success" type="submit">Search</button>
                </form>
            </div>
    
            

            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>User Name</th>
                        <th>Feedback</th>
                        <th>Rating</th>
                        <th>Submitted On</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>

                <tbody>
                    @if (pagedFeedbacks != null)
                    {
                        @foreach (var fb in pagedFeedbacks)
                        {
                            <tr>
                                <td>@fb.UserName</td>
                                <td>@fb.FeedbackText</td>
                                <td>@fb.Rating</td>
                                <td>@fb.SubmittedOn.ToString("f")</td>
                                <td>@fb.Status</td>
                                <td>
                                    <button class="btn btn-primary btn-sm" @onclick="() => ShowModal(fb)"> View
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>

            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    <li class="page-item @(size == 0 ? "disabled" : "")">
                        <a class="page-link" @onclick="BackwardPaging">Previous</a>
                    </li>

                    <li class="page-item @((size + PageSize) >= filteredFeedbacks.Count ? "disabled" : "")">
                        <a class="page-link" @onclick="ForwardPaging"> Next </a>
                    </li>
                </ul>
            </nav>

        </div>
    }
</div>

@if (selectedFeedback != null)
{
    <div class="modal fade show d-block"  tabindex="-1" style="background-color: rgba(0,0,0,0.5);">

        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Feedback Details</h5>
                    <button class="btn-close" @onclick="CloseModal"></button>
                </div>

                <div class="modal-body">
                    <p><strong>User Name:</strong> @selectedFeedback.UserName</p>
                    <p><strong>Feedback:</strong> @selectedFeedback.FeedbackText</p>
                    <p><strong>Rating:</strong> @selectedFeedback.Rating</p>
                    <p><strong>Status:</strong> @selectedFeedback.Status</p>
                    <p>
                        <strong>Submitted On:</strong> @selectedFeedback.SubmittedOn.ToString("f")
                    </p>
                </div>

                <div class="modal-footer">
                    @if (selectedFeedback.Status == "New")
                    {
                        <button class="btn btn-success" @onclick="UpdateStatus">
                            Mark as Reviewed
                        </button>
                    }

                    <button class="btn btn-secondary" @onclick="CloseModal">
                        Close
                    </button>

                    <button class="btn btn-danger" @onclick="DeleteFeedback">
                        Delete
                    </button>
                </div>

            </div>
        </div>
    </div>
}

@code
{
    private List<FeedbackDTO>? filteredFeedbacks;
    private List<FeedbackDTO>? pagedFeedbacks;
    private FeedbackDTO? selectedFeedback;

    private int size = 0;
    private const int PageSize = 10;

    protected override async Task OnInitializedAsync()
    {
        await LoadFeedbacks(null);
    }

    private async Task LoadFeedbacks(int? status)
    {
        ApiResponse? response;
        if(status==null)
            response = await Http.GetFromJsonAsync<ApiResponse>("api/feedback");
        else    
            response = await Http.GetFromJsonAsync<ApiResponse>($"api/feedback/{status}");
        filteredFeedbacks = response?.Data ?? new List<FeedbackDTO>();
        size = 0;
        ApplyPaging();
    }

    @* private async Task LoadNew()
    {
        var response = await Http.GetFromJsonAsync<ApiResponse>("api/feedback/0");
        filteredFeedbacks = response?.Data ?? new List<FeedbackDTO>();
        size = 0;
        ApplyPaging();
    }

    private async Task LoadReviewed()
    {
        var response = await Http.GetFromJsonAsync<ApiResponse>("api/feedback/1");
        filteredFeedbacks = response?.Data ?? new List<FeedbackDTO>();
        size = 0;
        ApplyPaging();
    } *@

    private void ApplyPaging()
    {
        if (filteredFeedbacks == null) return;

        pagedFeedbacks = filteredFeedbacks .Skip(size) .Take(PageSize).ToList();
    }

    private Task ForwardPaging()
    {
        size += PageSize;
        ApplyPaging();

        return Task.CompletedTask;
    }

    private Task BackwardPaging()
    {

        size -= PageSize;
        if (size < 0) size = 0;

        ApplyPaging();

        return Task.CompletedTask;
    }

    private void ShowModal(FeedbackDTO fb)
    {
        selectedFeedback = fb;
    }

    private void CloseModal()
    {
        selectedFeedback = null;
    }

    private async Task UpdateStatus()
    {
        if (selectedFeedback == null) return;

        var response =
            await Http.PutAsJsonAsync($"api/feedback/{selectedFeedback.Id}/1", new { });

        if (response.IsSuccessStatusCode)
        {
            selectedFeedback.Status = "Reviewed";
        }
    }

    private async Task DeleteFeedback()
    {
        if (selectedFeedback == null) return;

        var response =
            await Http.DeleteAsync($"api/feedback/{selectedFeedback.Id}");

        if (response.IsSuccessStatusCode)
        {
            filteredFeedbacks?.Remove(selectedFeedback);
            ApplyPaging();
            CloseModal();
        }
    }

    private class ApiResponse
    {
        public string? Message { get; set; }
        public List<FeedbackDTO>? Data { get; set; }
    }
}
